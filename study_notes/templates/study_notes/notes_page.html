{% extends "base.html" %}

{% load wagtailcore_tags wagtailimages_tags %}
{% load wagtailmath %}
{% load custom_filters %}
{% block body_class %}template-blogpage{% endblock %}

{% block content %}

    <div class="text-container">
        <h1>{{ page.title }}</h1>

        {% if page.tags.all.count %}
        <div class="tags d-flex justify-content-start flex-wrap">
            {% for tag in page.tags.all %}
                <a class="badge rounded-pill bg-info text-dark" style="font-size: 0.8em;margin: 1% 1% 1% 1%" href="{% slugurl 'tags' %}?tag={{ tag }}">{{ tag }}</a>
            {% endfor %}
        </div>
        <br>
        {% endif %}
        {% with categories=page.categories.all %}
            {% if categories %}
                <h3>Posted in:</h3>
                <ul>
                    {% for category in categories %}
                        <li style="display: inline">
                            {% image category.icon fill-32x32 style="vertical-align: middle" %}
                            {{ category.name }}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <p class="intro">{{ page.intro }}</p>
        {% for block in page.body %}
            {% if block.block_type == 'heading' %}
                <h2>{{ block.value }}</h2>
            {% elif block.block_type == 'image' %}
                <div class="custom-image" style="padding: 2vw;">
                    {% image block.value height-800 %}
                </div>
            {% elif block.block_type == "quiz" %}
                <div id="quiz-holder-{{ block.id }} succ-fail-{{ block.id }}">
                        <div class="card text-center">
                          <div class="card-header succ-fail-{{ block.id }} " id="quiz-title-{{ block.id }}">
                              <span style="float: left;margin-left:3em;">{{ block.value.title }}</span>
                              <div style="float:right;">
                                  <span class="badge rounded-pill bg-success">Score: <span id="quiz-score-{{ block.id }}">0</span></span>
                                  <span class="badge rounded-pill bg-danger">Passing Score: {{ block.value.passing_score }}</span>
                              </div>

                          </div>
                          <div class="card-body succ-fail-{{ block.id }}" id = quiz-body-{{ block.id }}>
                            <p class="card-text" id="quiz-q-{{ block.id }}">{{ quiz_starts|get_item:block.id }}</p>

                            <form class="form-group" id="quiz-btn-{{ block.id }}" onsubmit="return quizzes.quizRunner('{{ block.id }}');">
                                <label for="quiz-input-field-{{ block.id }}">Answer&nbsp;</label><input id="quiz-input-field-{{ block.id }}" type="text" >
                                <button class="btn btn-success" style="margin-top: -1%;" type="button" onclick="quizzes.quizRunner('{{ block.id }}')">Submit</button>

                            </form>
                            <div class="inline-block" id="quiz-btn-next-{{ block.id }}" style="display:none;">
                                <button class="btn btn-primary " type="button" onclick="quizzes.nextCard('{{ block.id }}')"><span id="quiz-btn-nextspan-{{ block.id }}">Next!</span></button>
                            </div>
                          </div>
                          <div class="card-footer succ-fail-{{ block.id }}">
                              Card <span id="quiz-progress-{{ block.id }}">1</span>/{{ quiz_lengths|get_item:block.id }}

                          </div>
                        </div>
                </div>
            {% elif block.block_type == "flashcards" %}
                <p>Flashcard placeholder, flashcards will be added later.
                    Each user will be able to post flashcards to notes pages and other users will then be able to subscribe to said flashcards.
                    The user will then hava an individual flashcard page where all the users own and subscribed cards are shown and practicable.
                </p>
            {% else %}
                <div>
                    <section class="block-{{ block.block_type }}">
                        {% include_block block %}
                    </section>
                </div>
            {% endif %}
            <hr>


        {% endfor %}

        {% for item in page.gallery_images.all %}
            <div style="float: left; margin: 10px">
                {% image item.image fill-320x240 %}
                <p>{{ item.caption }}</p>
            </div>
        {% endfor %}
        <small class="text-muted">Edited: {{ page.date }}</small>
        <br>
        <small class="text-muted">By {{ page.owner }}</small>
        <br>
        <br>
        <div class="text-center">
            <a href="{{ page.get_parent.url }}"><button type="button" class="btn btn-primary btn-lg">Return to all notes</button></a>
        </div>

    </div>

{% endblock %}

{% block custom_scripts %}
    <script src="{% mathjax %}"></script>
    <script lang="js">
        let quiz_data = {{ quiz_json|safe }};

        function validateAnswer(input, cardElement) {
            input = String(input).trim();
            cardElement = String(cardElement).trim();
            if (input === cardElement) {
                return true
            } else if (input.toLowerCase() === cardElement.toLowerCase()) {
                return true
            }
            return false
        }

        class Quizzes {
            constructor() {
                this.quizzes = {};
                this.scores = {};
            }

            nextCard(counter) {
                document.getElementById("quiz-btn-next-"+counter).style.display = "none";


                let quiz = quiz_data[counter];
                let cards = quiz["cards"];
                document.getElementById("quiz-btn-"+counter).style.display = "initial";
                for (const div of document.getElementsByClassName("succ-fail-"+counter)) {
                        let divClasses = div.classList;
                        divClasses.remove("failure-quiz");

                        divClasses.remove("correct-quiz")
                    }

                if (this.quizzes[counter] in cards) {
                    document.getElementById("quiz-q-"+counter).innerHTML = cards[this.quizzes[counter]]["q"];
                } else {
                    this.begin(counter);
                    document.getElementById("quiz-progress-"+counter).innerHTML = 1+this.quizzes[counter];

                    return this.nextCard(counter);
                }

                if (!(this.quizzes[counter]+1 in cards)) {
                    document.getElementById("quiz-progress-"+counter).innerHTML = 1+this.quizzes[counter];

                }
                return false
            }

            begin(counter) {
                this.quizzes[counter] = 0;
                this.scores[counter] = 0;
            }

            quizRunner(counter) {
                if (!(counter in this.quizzes)) {
                    this.begin(counter);
                }
                let quiz = quiz_data[counter];
                let input_element = document.getElementById("quiz-input-field-"+counter);
                let input = undefined;
                if (!(input_element === undefined)) {
                    input = input_element.value;
                }
                let cards = quiz["cards"];

                if (this.quizzes[counter] in cards) {
                    if (!(input === null)) {
                        let card = cards[this.quizzes[counter]];
                        let correct = validateAnswer(input, card["a"]);
                        for (const div of document.getElementsByClassName("succ-fail-"+counter)) {
                        let divClasses = div.classList;
                        if (correct) {
                            divClasses.remove("failure-quiz");
                            divClasses.add("correct-quiz")
                        } else {
                            divClasses.add("failure-quiz");
                            divClasses.remove("correct-quiz")
                        }
                        }
                        document.getElementById("quiz-btn-"+counter).style.display = "none";
                        if (correct) {
                            this.scores[counter]= this.scores[counter] + parseInt(card["score"]);
                            document.getElementById("quiz-q-"+counter).innerHTML = "You answered correctly!";
                        } else {
                            document.getElementById("quiz-q-"+counter).innerHTML = "You answered incorrectly("+'"'+input+'"'+") correct was " + '"' + cards[this.quizzes[counter]]["a"] + '"';
                        }
                    }


                    document.getElementById("quiz-btn-next-"+counter).style.display = "inline";

                    this.quizzes[counter]+=1;
                    document.getElementById("quiz-score-"+counter).innerHTML = this.scores[counter];
                    if (!(this.quizzes[counter] in cards)) {
                        let passed = this.scores[counter] >= quiz["passing_score"];
                        if (passed) {
                            let temp = document.getElementById("quiz-q-"+counter).innerText;
                            document.getElementById("quiz-q-"+counter).innerHTML = temp + " | You Passed!";
                        }
                        document.getElementById("quiz-btn-nextspan-"+counter).innerHTML = "Slut p√• kort, starta om!";
                    } else {
                        document.getElementById("quiz-btn-nextspan-"+counter).innerHTML = "Next";
                    }
                }
            return false
        }
        }

        let quizzes = new Quizzes();


    </script>
{% endblock %}

