{% extends 'base.html' %}

{% block content %}
    <div class="hero bg-base-300">
        <div class="hero-content text-center">
            <div class="max-w-md gap-4 flex flex-col">
                <h1 class="text-5xl font-bold">{{ data_store.name|capfirst }}</h1>
                {% if data_store.description %}
                    <p>{{ data_store.description|capfirst }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container my-prose py-8">
        {% if not shared %}
            <h3>A short python example to post data.</h3>
            <div class="mockup-code not-prose">
                <pre data-prefix="1"><code>url = "{{ request.scheme }}://{{ request.get_host }}/data/access/<strong>{{ data_store.key }}</strong>"</code></pre>
                <pre data-prefix="2"><code>resp = requests.post(url, json={{ data_store.example_entry }}, headers={'Authorization': 'TOK:SECRET_API_TOKEN'}).text</code></pre>
            </div>
        {% endif %}
        <h4>Now only plotting last 10k datapoints by default.</h4>
        {% for plot in plots %}
            <h2>{{ plot.name }}</h2>
            <p id="chart-p-{{ forloop.counter0 }}"
               style="text-decoration-line: underline;text-decoration-color: red"></p>
            {% if not shared %}
                <div class="btn-group">
                    <a class="btn btn-secondary" href="{% url 'modify_plot' plot.id %}">Modify</a>
                    <a class="btn btn-primary" href="{% url 'plot_all_can_view' data_store.key %}">Share this! <small>All
                        with this link can view</small></a>
                </div>
            {% endif %}
            <div class="plot text-center m-auto">
                <canvas id="chart{{ forloop.counter0 }}"></canvas>
            </div>

        {% endfor %}
        {% if form %}
            <h1>Add a new chart</h1>
            <form method="post" action="{% url 'plot' data_store.key %}">
                {% csrf_token %}
                {% include "dashboard/forms/form.html" %}
                <button class="btn btn-primary" type="submit" value="Submit">Submit</button>
            </form>
        {% endif %}
    </div>
{% endblock %}
{% block custom_scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.js"
            integrity="sha512-d6nObkPJgV791iTGuBoVC9Aa2iecqzJRE0Jiqvk85BhLHAPhWqkuBiQb1xz2jvuHNqHLYoN3ymPfpiB1o+Zgpw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        {# Todo, modify so that choosing timeframes is possible, should probably stream data as that happends. #}
        {% for plot in plots %}
            {% with plot.plottable as plt %}
                {% if plt != "No data." %}
                    const ctx{{ forloop.counter0 }} = document.getElementById('chart{{ forloop.counter0 }}');
                    const myChart{{ forloop.counter0 }} = new Chart(ctx{{ forloop.counter0 }}, {{ plt | safe }});
                {% else %}
                    document.getElementById('chart-p-{{ forloop.counter0 }}').innerHTML = "No data present to plot";
                {% endif %}
            {% endwith %}
        {% endfor %}

    </script>

{% endblock %}